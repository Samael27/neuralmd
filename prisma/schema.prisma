generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector]
}

model Note {
  id        String   @id @default(cuid())
  title     String
  content   String   @db.Text
  
  // Vector embedding for semantic search
  // Dimensions depend on the embedding provider:
  // - OpenAI text-embedding-3-small: 1536
  // - Ollama nomic-embed-text: 768
  // Using Unsupported to handle variable dimensions via raw SQL
  embedding Unsupported("vector")?
  
  // Metadata
  tags      String[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Source tracking (human or AI)
  source    String   @default("human") // "human" | "ai" | "import"
  sourceRef String?  // Optional reference (e.g., AI session ID)
  
  // Multi-tenant support (optional - null for single-tenant mode)
  userId    String?
  
  @@index([userId])
  @@map("notes")
}

model Connection {
  id        String   @id @default(cuid())
  
  // The two connected notes
  fromId    String
  toId      String
  
  // Connection strength (0-1, based on semantic similarity)
  strength  Float
  
  // How the connection was made
  type      String   @default("semantic") // "semantic" | "manual" | "reference"
  
  createdAt DateTime @default(now())
  
  @@unique([fromId, toId])
  @@map("connections")
}

// Multi-tenant: User accounts (only used when MULTI_TENANT=true)
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  passwordHash  String?   // For email/password auth
  
  // OAuth
  provider      String?   // "google" | "github" | null (email/password)
  providerId    String?   // OAuth provider user ID
  
  // Subscription/billing
  plan          String    @default("free") // "free" | "pro" | "team"
  stripeCustomerId String?
  
  // Limits
  notesCount    Int       @default(0)
  apiCallsCount Int       @default(0)
  apiCallsResetAt DateTime?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@unique([provider, providerId])
  @@map("users")
}

model ApiKey {
  id          String    @id @default(cuid())
  name        String    // Friendly name for the key
  keyHash     String    @unique // SHA256 hash of the key (never store plaintext)
  
  isActive    Boolean   @default(true)
  
  // Optional expiration
  expiresAt   DateTime?
  
  // Usage tracking
  lastUsedAt  DateTime?
  createdAt   DateTime  @default(now())
  
  // Multi-tenant support (optional - null for single-tenant/admin keys)
  userId      String?
  
  @@index([userId])
  @@map("api_keys")
}
